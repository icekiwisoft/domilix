name: CD

on:
  push:
    branches:
      - main
      - master
  workflow_run:
    workflows:
      - Docker Publish
    types:
      - completed
  workflow_dispatch:

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: read

jobs:
  prepare-deploy:
    name: Prepare deploy files
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Ensure deploy directory exists
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: domilix.com
          username: root
          key: ${{ secrets.VPS_SSH }}
          script: mkdir -p /opt/domilix/deploy

      - name: Upload deploy files
        uses: burnett01/rsync-deployments@7.0.2
        with:
          switches: -avzr --delete --exclude=.env.production
          path: deploy/
          remote_path: /opt/domilix/deploy/
          remote_host: domilix.com
          remote_user: root
          remote_key: ${{ secrets.VPS_SSH }}

  deploy-frontend:
    name: Deploy Frontend Service
    runs-on: ubuntu-latest
    needs: prepare-deploy
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Deploy frontend compose
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: domilix.com
          username: root
          key: ${{ secrets.VPS_SSH }}
          script: |
            set -e
            cd /opt/domilix

            GHCR_USER="${{ secrets.GHCR_USERNAME }}"
            GHCR_PASS="${{ secrets.GHCR_TOKEN }}"

            if [ -z "$GHCR_USER" ] || [ -z "$GHCR_PASS" ]; then
              GHCR_USER="${{ github.actor }}"
              GHCR_PASS="${{ secrets.GITHUB_TOKEN }}"
              echo "Using GitHub Actions token for GHCR login"
            fi

            echo "$GHCR_PASS" | docker login ghcr.io -u "$GHCR_USER" --password-stdin

            if [ ! -f deploy/.env.production ]; then
              cp deploy/.env.production.example deploy/.env.production
              echo "deploy/.env.production created from example. Update it with real values."
            fi

            DEPLOY_TAG="${{ github.event.workflow_run.head_branch || github.ref_name || 'latest' }}"
            FRONTEND_IMAGE="ghcr.io/${{ github.repository_owner }}/domilix-frontend:${DEPLOY_TAG}"

            echo "Deploying frontend image: ${FRONTEND_IMAGE}"

            FRONTEND_IMAGE="$FRONTEND_IMAGE" docker compose -p domilix_frontend --env-file deploy/.env.production -f deploy/docker-compose.domilix.com.yml pull frontend
            FRONTEND_IMAGE="$FRONTEND_IMAGE" docker compose -p domilix_frontend --env-file deploy/.env.production -f deploy/docker-compose.domilix.com.yml up -d --remove-orphans frontend

  deploy-backend:
    name: Deploy Backend Service
    runs-on: ubuntu-latest
    needs: prepare-deploy
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Deploy backend compose
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: domilix.com
          username: root
          key: ${{ secrets.VPS_SSH }}
          script: |
            set -e
            cd /opt/domilix

            GHCR_USER="${{ secrets.GHCR_USERNAME }}"
            GHCR_PASS="${{ secrets.GHCR_TOKEN }}"

            if [ -z "$GHCR_USER" ] || [ -z "$GHCR_PASS" ]; then
              GHCR_USER="${{ github.actor }}"
              GHCR_PASS="${{ secrets.GITHUB_TOKEN }}"
              echo "Using GitHub Actions token for GHCR login"
            fi

            echo "$GHCR_PASS" | docker login ghcr.io -u "$GHCR_USER" --password-stdin

            if [ ! -f deploy/.env.production ]; then
              cp deploy/.env.production.example deploy/.env.production
              echo "deploy/.env.production created from example. Update it with real values."
            fi

            DEPLOY_TAG="${{ github.event.workflow_run.head_branch || github.ref_name || 'latest' }}"
            BACKEND_IMAGE="ghcr.io/${{ github.repository_owner }}/domilix-backend:${DEPLOY_TAG}"

            echo "Deploying backend image: ${BACKEND_IMAGE}"

            BACKEND_IMAGE="$BACKEND_IMAGE" docker compose -p domilix_backend --env-file deploy/.env.production -f deploy/docker-compose.api.domilix.com.yml pull backend
            BACKEND_IMAGE="$BACKEND_IMAGE" docker compose -p domilix_backend --env-file deploy/.env.production -f deploy/docker-compose.api.domilix.com.yml up -d --remove-orphans

      - name: Optional post-deploy command
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: domilix.com
          username: root
          key: ${{ secrets.VPS_SSH }}
          script: |
            if [ -n "${{ secrets.POST_DEPLOY_CMD }}" ]; then
              ${{ secrets.POST_DEPLOY_CMD }}
            fi
