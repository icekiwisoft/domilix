name: CD

on:
  push:
    branches:
      - main
      - master

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect changed apps
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Filter paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'domilix.com/**'
              - 'deploy/**'
              - '.github/workflows/cd.yml'
            backend:
              - 'api.domilix.com/**'
              - 'deploy/**'
              - '.github/workflows/cd.yml'

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    defaults:
      run:
        working-directory: domilix.com
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: domilix.com/pnpm-lock.yaml

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        run: pnpm run build

      - name: Ensure frontend deploy directory exists
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: domilix.com
          username: root
          key: ${{ secrets.VPS_SSH }}
          script: mkdir -p /opt/domilix/domilix.com/dist

      - name: Upload static build via rsync
        uses: burnett01/rsync-deployments@7.0.2
        with:
          switches: -avzr --delete
          path: domilix.com/dist/
          remote_path: /opt/domilix/domilix.com/dist/
          remote_host: domilix.com
          remote_user: root
          remote_key: ${{ secrets.VPS_SSH }}

      - name: Optional frontend post-deploy command
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: domilix.com
          username: root
          key: ${{ secrets.VPS_SSH }}
          script: |
            if [ -n "${{ secrets.FRONTEND_POST_DEPLOY_CMD }}" ]; then
              ${{ secrets.FRONTEND_POST_DEPLOY_CMD }}
            else
              echo "No FRONTEND_POST_DEPLOY_CMD configured"
            fi

  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure backend deploy directory exists
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: domilix.com
          username: root
          key: ${{ secrets.VPS_SSH }}
          script: mkdir -p /opt/domilix/api.domilix.com

      - name: Upload backend source via rsync
        uses: burnett01/rsync-deployments@7.0.2
        with:
          switches: -avzr --delete --exclude=.env --exclude=vendor --exclude=node_modules --exclude=storage/logs
          path: api.domilix.com/
          remote_path: /opt/domilix/api.domilix.com/
          remote_host: domilix.com
          remote_user: root
          remote_key: ${{ secrets.VPS_SSH }}

      - name: Ensure backend writable directories exist
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: domilix.com
          username: root
          key: ${{ secrets.VPS_SSH }}
          script: |
            mkdir -p /opt/domilix/api.domilix.com/storage
            mkdir -p /opt/domilix/api.domilix.com/bootstrap/cache

      - name: Run backend deployment commands
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: domilix.com
          username: root
          key: ${{ secrets.VPS_SSH }}
          script: |
            set -e
            cd /opt/domilix/api.domilix.com
            composer install --no-dev --optimize-autoloader --no-interaction
            php artisan migrate --force
            php artisan optimize
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            if [ -n "${{ secrets.BACKEND_POST_DEPLOY_CMD }}" ]; then
              ${{ secrets.BACKEND_POST_DEPLOY_CMD }}
            fi
