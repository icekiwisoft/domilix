name: CD

on:
  push:
    branches:
      - main
      - master

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: read

jobs:
  deploy-docker:
    name: Deploy Docker Stack
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure deploy directory exists
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: domilix.com
          username: root
          key: ${{ secrets.VPS_SSH }}
          script: mkdir -p /opt/domilix/deploy

      - name: Upload deploy files
        uses: burnett01/rsync-deployments@7.0.2
        with:
          switches: -avzr --delete --exclude=.env.production
          path: deploy/
          remote_path: /opt/domilix/deploy/
          remote_host: domilix.com
          remote_user: root
          remote_key: ${{ secrets.VPS_SSH }}

      - name: Deploy containers with Docker Compose
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: domilix.com
          username: root
          key: ${{ secrets.VPS_SSH }}
          script: |
            set -e
            cd /opt/domilix

            GHCR_USER="${{ secrets.GHCR_USERNAME }}"
            GHCR_PASS="${{ secrets.GHCR_TOKEN }}"

            if [ -z "$GHCR_USER" ] || [ -z "$GHCR_PASS" ]; then
              GHCR_USER="${{ github.actor }}"
              GHCR_PASS="${{ secrets.GITHUB_TOKEN }}"
              echo "Using GitHub Actions token for GHCR login"
            fi

            echo "$GHCR_PASS" | docker login ghcr.io -u "$GHCR_USER" --password-stdin

            if [ ! -f deploy/.env.production ]; then
              cp deploy/.env.production.example deploy/.env.production
              echo "deploy/.env.production created from example. Update it with real values."
            fi

            sed -i "s|ghcr.io/your-org/|ghcr.io/${{ github.repository_owner }}/|g" deploy/.env.production

            docker compose --env-file deploy/.env.production -f deploy/docker-compose.prod.yml pull
            docker compose --env-file deploy/.env.production -f deploy/docker-compose.prod.yml up -d --remove-orphans

            if [ -n "${{ secrets.POST_DEPLOY_CMD }}" ]; then
              ${{ secrets.POST_DEPLOY_CMD }}
            fi
